
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mongodb NodeJs 组件中文文档">
      
      
      
        <meta name="author" content="Nosy">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.2">
    
    
      
        <title>升级到5 - Mongoose文档</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.24c991ad.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Mongoose文档" class="md-header__button md-logo" aria-label="Mongoose文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mongoose文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              升级到5
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/wdk-docs/mongoose-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    wdk-docs/mongoose-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Mongoose文档" class="md-nav__button md-logo" aria-label="Mongoose文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Mongoose文档
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/wdk-docs/mongoose-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    wdk-docs/mongoose-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        前言
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../QuickStart/" class="md-nav__link">
        快速开始
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          连接
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="连接" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          连接
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../connection/guide/" class="md-nav__link">
        连接手册
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../connection/api/" class="md-nav__link">
        连接API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="模式" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../schema/guide/" class="md-nav__link">
        模式手册
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../schema/api/" class="md-nav__link">
        模式API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../schema/type/" class="md-nav__link">
        模式类型API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          模型
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="模型" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          模型
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../model/guide/" class="md-nav__link">
        模型手册
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../model/api/" class="md-nav__link">
        模型API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          文档
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="文档" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          文档
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../document/guide/" class="md-nav__link">
        文档手册
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../document/api/" class="md-nav__link">
        文档API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          查询
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="查询" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          查询
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../query/guide/" class="md-nav__link">
        查询手册
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../query/api/" class="md-nav__link">
        查询API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          其它手册
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="其它手册" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          其它手册
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../guide/Validation/" class="md-nav__link">
        验证
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../guide/Middleware/" class="md-nav__link">
        中间件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../guide/Populate/" class="md-nav__link">
        填充
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../guide/Discriminators/" class="md-nav__link">
        鉴别器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../guide/Plugins/" class="md-nav__link">
        插件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          其它API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="其它API" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          其它API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/Aggregate/" class="md-nav__link">
        聚合
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/VirtualType/" class="md-nav__link">
        虚拟类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/Error/" class="md-nav__link">
        错误
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          升级到5
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        升级到5
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    版本要求
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    查询中间件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promises-and-callbacks-for-mongooseconnect" class="md-nav__link">
    Promises and Callbacks for mongoose.connect()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection-logic-and-usemongoclient" class="md-nav__link">
    Connection Logic and useMongoClient
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setter-order" class="md-nav__link">
    Setter Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-values-for-remove-and-deletex" class="md-nav__link">
    Return Values for remove() and deleteX()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    聚合游标
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geonear" class="md-nav__link">
    geoNear
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    域套接字
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toobject" class="md-nav__link">
    toObject() 选项
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    聚合参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    布尔投射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    查询投射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-save-hooks-get-flow-control" class="md-nav__link">
    Post Save Hooks Get Flow Control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pushall-operator" class="md-nav__link">
    The $pushAll Operator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#always-use-forward-key-order" class="md-nav__link">
    Always Use Forward Key Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    预编译的浏览器包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    保存错误
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-hook-signatures" class="md-nav__link">
    Init hook signatures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numaffected-save" class="md-nav__link">
    numAffected 和 save()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-and-debouncing" class="md-nav__link">
    remove() and debouncing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getpromiseconstructor" class="md-nav__link">
    getPromiseConstructor()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-parameters-from-pre-hooks" class="md-nav__link">
    Passing Parameters from Pre Hooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required" class="md-nav__link">
    数组的required验证器
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../VersionCompatibility/" class="md-nav__link">
        版本兼容性
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../FAQ/" class="md-nav__link">
        常问问题
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          驱动
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="驱动" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          驱动
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MongoDB_NodeJS_Driver/unified-topology/" class="md-nav__link">
        unified-topology
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    版本要求
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    查询中间件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promises-and-callbacks-for-mongooseconnect" class="md-nav__link">
    Promises and Callbacks for mongoose.connect()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection-logic-and-usemongoclient" class="md-nav__link">
    Connection Logic and useMongoClient
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setter-order" class="md-nav__link">
    Setter Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-values-for-remove-and-deletex" class="md-nav__link">
    Return Values for remove() and deleteX()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    聚合游标
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geonear" class="md-nav__link">
    geoNear
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    域套接字
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toobject" class="md-nav__link">
    toObject() 选项
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    聚合参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    布尔投射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    查询投射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-save-hooks-get-flow-control" class="md-nav__link">
    Post Save Hooks Get Flow Control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pushall-operator" class="md-nav__link">
    The $pushAll Operator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#always-use-forward-key-order" class="md-nav__link">
    Always Use Forward Key Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    预编译的浏览器包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    保存错误
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-hook-signatures" class="md-nav__link">
    Init hook signatures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numaffected-save" class="md-nav__link">
    numAffected 和 save()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-and-debouncing" class="md-nav__link">
    remove() and debouncing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getpromiseconstructor" class="md-nav__link">
    getPromiseConstructor()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passing-parameters-from-pre-hooks" class="md-nav__link">
    Passing Parameters from Pre Hooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required" class="md-nav__link">
    数组的required验证器
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="5">升级到5<a class="headerlink" href="#5" title="Permanent link">&para;</a></h1>
<h2 id="_1">版本要求<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Mongoose now requires node.js &gt;= 4.0.0 and MongoDB &gt;= 3.0.0. <a href="https://www.mongodb.com/blog/post/mongodb-2-6-end-of-life">MongoDB 2.6</a> and <a href="https://github.com/nodejs/Release">Node.js &lt; 4</a> where both EOL-ed in 2016.</p>
<h2 id="_2">查询中间件<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Query middleware is now compiled when you call <code>mongoose.model()</code> or <code>db.model()</code>. If you add query middleware after calling <code>mongoose.model()</code>, that middleware will <strong>not</strong> get called.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">MyModel</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">);</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;find!&#39;</span><span class="p">);</span> <span class="p">});</span>

<span class="nx">MyModel</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// In mongoose 4.x, the above `.find()` will print &quot;find!&quot;</span>
  <span class="c1">// In mongoose 5.x, &quot;find!&quot; will **not** be printed.</span>
  <span class="c1">// Call `pre(&#39;find&#39;)` **before** calling `mongoose.model()` to make the middleware apply.</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="promises-and-callbacks-for-mongooseconnect">Promises and Callbacks for <code>mongoose.connect()</code><a class="headerlink" href="#promises-and-callbacks-for-mongooseconnect" title="Permanent link">&para;</a></h2>
<p><code>mongoose.connect()</code> and <code>mongoose.disconnect()</code> now return a promise if no callback specified, or <code>null</code> otherwise. It does <strong>not</strong> return the mongoose singleton.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Worked in mongoose 4. Does **not** work in mongoose 5, `mongoose.connect()`</span>
<span class="c1">// now returns a promise consistently. This is to avoid the horrible things</span>
<span class="c1">// we&#39;ve done to allow mongoose to be a thenable that resolves to itself.</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;mongodb://localhost:27017/test&#39;</span><span class="p">).</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({}));</span>

<span class="c1">// Do this instead</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;mongodb://localhost:27017/test&#39;</span><span class="p">);</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({}));</span>
</code></pre></div>
<h2 id="connection-logic-and-usemongoclient">Connection Logic and <code>useMongoClient</code><a class="headerlink" href="#connection-logic-and-usemongoclient" title="Permanent link">&para;</a></h2>
<p>The <a href="http://mongoosejs.com/docs/4.x/docs/connections.html#use-mongo-client"><code>useMongoClient</code> option</a> was
removed in Mongoose 5, it is now always <code>true</code>. As a consequence, Mongoose 5
no longer supports several function signatures for <code>mongoose.connect()</code> that
worked in Mongoose 4.x if the <code>useMongoClient</code> option was off. Below are some
examples of <code>mongoose.connect()</code> calls that do <strong>not</strong> work in Mongoose 5.x.</p>
<ul>
<li><code>mongoose.connect('localhost', 27017);</code></li>
<li><code>mongoose.connect('localhost', 'mydb', 27017);</code></li>
<li><code>mongoose.connect('mongodb://host1:27017,mongodb://host2:27017');</code></li>
</ul>
<p>In Mongoose 5.x, the first parameter to <code>mongoose.connect()</code> and <code>mongoose.createConnection()</code>, if specified, <strong>must</strong> be a <a href="https://docs.mongodb.com/manual/reference/connection-string/">MongoDB connection string</a>. The
connection string and options are then passed down to <a href="http://mongodb.github.io/node-mongodb-native/3.0/api/MongoClient.html#.connect">the MongoDB Node.js driver's <code>MongoClient.connect()</code> function</a>. Mongoose does not modify the connection string, although <code>mongoose.connect()</code> and <code>mongoose.createConnection()</code> support a <a href="http://mongoosejs.com/docs/connections.html#options">few additional options in addition to the ones the MongoDB driver supports</a>.</p>
<h2 id="setter-order">Setter Order<a class="headerlink" href="#setter-order" title="Permanent link">&para;</a></h2>
<p>Setters run in reverse order in 4.x:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span> <span class="p">});</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span>
  <span class="nx">get</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;This will print 2nd&#39;</span><span class="p">)).</span>
  <span class="nx">get</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;This will print first&#39;</span><span class="p">));</span>
</code></pre></div>
<p>In 5.x, setters run in the order they're declared.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span> <span class="p">});</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span>
  <span class="nx">get</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;This will print first&#39;</span><span class="p">)).</span>
  <span class="nx">get</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;This will print 2nd&#39;</span><span class="p">));</span>
</code></pre></div>
<h2 id="return-values-for-remove-and-deletex">Return Values for <code>remove()</code> and <code>deleteX()</code><a class="headerlink" href="#return-values-for-remove-and-deletex" title="Permanent link">&para;</a></h2>
<p><code>deleteOne()</code>, <code>deleteMany()</code>, and <code>remove()</code> now resolve to the result object
rather than the full <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~writeOpCallback">driver <code>WriteOpResult</code> object</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// In 4.x, this is how you got the number of documents deleted</span>
<span class="nx">MyModel</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">n</span><span class="p">));</span>
<span class="c1">// In 5.x this is how you get the number of documents deleted</span>
<span class="nx">MyModel</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">n</span><span class="p">);</span>
</code></pre></div>
<h2 id="_3">聚合游标<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>The <code>useMongooseAggCursor</code> option from 4.x is now always on. This is the new syntax for aggregation cursors in mongoose 5:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// When you call `.cursor()`, `.exec()` will now return a mongoose aggregation</span>
<span class="c1">// cursor.</span>
<span class="kd">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">MyModel</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Val&#39;</span> <span class="p">}</span> <span class="p">}]).</span><span class="nx">cursor</span><span class="p">().</span><span class="nx">exec</span><span class="p">();</span>
<span class="c1">// No need to `await` on the cursor or wait for a promise to resolve</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">eachAsync</span><span class="p">(</span><span class="nx">doc</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>

<span class="c1">// Can also pass options to `cursor()`</span>
<span class="kd">const</span> <span class="nx">cursorWithOptions</span> <span class="o">=</span> <span class="nx">MyModel</span><span class="p">.</span>
  <span class="nx">aggregate</span><span class="p">([{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Val&#39;</span> <span class="p">}</span> <span class="p">}]).</span>
  <span class="nx">cursor</span><span class="p">({</span> <span class="nx">batchSize</span><span class="o">:</span> <span class="mf">10</span> <span class="p">}).</span>
  <span class="nx">exec</span><span class="p">();</span>
</code></pre></div>
<h2 id="geonear">geoNear<a class="headerlink" href="#geonear" title="Permanent link">&para;</a></h2>
<p><code>Model.geoNear()</code> has been removed because the <a href="https://github.com/mongodb/node-mongodb-native/blob/3.0.0/CHANGES_3.0.0.md#geonear-command-helper">MongoDB driver no longer supports it</a></p>
<h2 id="_4">域套接字<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>域套接字必须是URI编码的。 例如：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 在mongoose 4工作。 由于更严格的URI解析，**没有**在mongoose 5中工作。</span>
<span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="s1">&#39;/tmp/mongodb-27017.sock&#39;</span><span class="p">;</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="sb">`mongodb://aaron:psw@</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">/fake`</span><span class="p">);</span>

<span class="c1">// 做这件事</span>
<span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="s1">&#39;/tmp/mongodb-27017.sock&#39;</span><span class="p">);</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="sb">`mongodb://aaron:psw@</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">/fake`</span><span class="p">);</span>
</code></pre></div>
<h2 id="toobject"><code>toObject()</code> 选项<a class="headerlink" href="#toobject" title="Permanent link">&para;</a></h2>
<p>The <code>options</code> parameter to <code>toObject()</code> and <code>toJSON()</code> merge defaults rather than overwriting them.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Note the `toObject` option below</span>
<span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nb">String</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">toObject</span><span class="o">:</span> <span class="p">{</span> <span class="nx">virtuals</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">virtual</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="mf">42</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">MyModel</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;MyModel&#39;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">MyModel</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span> <span class="p">});</span>
<span class="c1">// In mongoose 4.x this prints &quot;undefined&quot;, because `{ minimize: false }`</span>
<span class="c1">// overwrites the entire schema-defined options object.</span>
<span class="c1">// In mongoose 5.x this prints &quot;42&quot;, because `{ minimize: false }` gets</span>
<span class="c1">// merged with the schema-defined options.</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">({</span> <span class="nx">minimize</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}).</span><span class="nx">answer</span><span class="p">);</span>
</code></pre></div>
<h2 id="_5">聚合参数<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p><code>aggregate()</code> no longer accepts a spread, you <strong>must</strong> pass your aggregation pipeline as an array. The below code worked in 4.x:</p>
<div class="highlight"><pre><span></span><code><span class="nx">MyModel</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">({</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">isDeleted</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mf">10</span> <span class="p">}).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
</code></pre></div>
<p>The above code does <strong>not</strong> work in 5.x, you <strong>must</strong> wrap the <code>$match</code> and <code>$skip</code> stages in an array.</p>
<div class="highlight"><pre><span></span><code><span class="nx">MyModel</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span> <span class="nx">$match</span><span class="o">:</span> <span class="p">{</span> <span class="nx">isDeleted</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mf">10</span> <span class="p">}]).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
</code></pre></div>
<h2 id="_6">布尔投射<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>By default, mongoose 4 would coerce any value to a boolean without error.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Fine in mongoose 4, would save a doc with `boolField = true`</span>
<span class="kd">const</span> <span class="nx">MyModel</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="nx">boolField</span><span class="o">:</span> <span class="nb">Boolean</span>
<span class="p">}));</span>

<span class="nx">MyModel</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">boolField</span><span class="o">:</span> <span class="s1">&#39;not a boolean&#39;</span> <span class="p">});</span>
</code></pre></div>
<p>Mongoose 5 only casts the following values to <code>true</code>:</p>
<ul>
<li><code>true</code></li>
<li><code>'true'</code></li>
<li><code>1</code></li>
<li><code>'1'</code></li>
<li><code>'yes'</code></li>
</ul>
<p>And the following values to <code>false</code>:</p>
<ul>
<li><code>false</code></li>
<li><code>'false'</code></li>
<li><code>0</code></li>
<li><code>'0'</code></li>
<li><code>'no'</code></li>
</ul>
<p>All other values will cause a <code>CastError</code></p>
<h2 id="_7">查询投射<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>Casting for <code>update()</code>, <code>updateOne()</code>, <code>updateMany()</code>, <code>replaceOne()</code>,
<code>remove()</code>, <code>deleteOne()</code>, and <code>deleteMany()</code> doesn't happen until <code>exec()</code>.
This makes it easier for hooks and custom query helpers to modify data, because
mongoose won't restructure the data you passed in until after your hooks and
query helpers have ran. It also makes it possible to set the <code>overwrite</code> option
<em>after</em> passing in an update.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// In mongoose 4.x, this becomes `{ $set: { name: &#39;Baz&#39; } }` despite the `overwrite`</span>
<span class="c1">// In mongoose 5.x, this overwrite is respected and the first document with</span>
<span class="c1">// `name = &#39;Bar&#39;` will be replaced with `{ name: &#39;Baz&#39; }`</span>
<span class="nx">User</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bar&#39;</span> <span class="p">}).</span><span class="nx">update</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Baz&#39;</span> <span class="p">}).</span><span class="nx">setOptions</span><span class="p">({</span> <span class="nx">overwrite</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</code></pre></div>
<h2 id="post-save-hooks-get-flow-control">Post Save Hooks Get Flow Control<a class="headerlink" href="#post-save-hooks-get-flow-control" title="Permanent link">&para;</a></h2>
<p>Post hooks now get flow control, which means async post save hooks and child document post save hooks execute <strong>before</strong> your <code>save()</code> callback.</p>
<div class="highlight"><pre><span></span><code>const ChildModelSchema = new mongoose.Schema({
  text: {
    type: String
  }
});
ChildModelSchema.post(&#39;save&#39;, function(doc) {
  // In mongoose 5.x this will print **before** the `console.log()`
  // in the `save()` callback. In mongoose 4.x this was reversed.
  console.log(&#39;Child post save&#39;);
});
const ParentModelSchema = new mongoose.Schema({
  children: [ChildModelSchema]
});

const Model = mongoose.model(&#39;Parent&#39;, ParentModelSchema);
const m = new Model({ children: [{ text: &#39;test&#39; }] });
m.save(function() {
  // In mongoose 5.xm this prints **after** the &quot;Child post save&quot; message.
  console.log(&#39;Save callback&#39;);
});
</code></pre></div>
<h2 id="the-pushall-operator">The <code>$pushAll</code> Operator<a class="headerlink" href="#the-pushall-operator" title="Permanent link">&para;</a></h2>
<p><code>$pushAll</code> is no longer supported and no longer used internally for <code>save()</code>, since it has been <a href="https://docs.mongodb.com/manual/reference/operator/update/pushAll/">deprecated since MongoDB 2.4</a>. Use <code>$push</code> with <code>$each</code> instead.</p>
<h2 id="always-use-forward-key-order">Always Use Forward Key Order<a class="headerlink" href="#always-use-forward-key-order" title="Permanent link">&para;</a></h2>
<p>The <code>retainKeyOrder</code> option was removed, mongoose will now always retain the same key position when cloning objects. If you have queries or indexes that rely on reverse key order, you will have to change them.</p>
<h2 id="_8">预编译的浏览器包<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>We no longer have a pre-compiled version of mongoose for the browser. If you want to use mongoose schemas in the browser, you need to build your own bundle with browserify/webpack.</p>
<h2 id="_9">保存错误<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>The <code>saveErrorIfNotFound</code> option was removed, mongoose will now always error out from <code>save()</code> if the underlying document was not found</p>
<h2 id="init-hook-signatures">Init hook signatures<a class="headerlink" href="#init-hook-signatures" title="Permanent link">&para;</a></h2>
<p><code>init</code> hooks are now fully synchronous and do not receive <code>next()</code> as a parameter.</p>
<p><code>Document.prototype.init()</code> no longer takes a callback as a parameter. It
was always synchronous, just had a callback for legacy reasons.</p>
<h2 id="numaffected-save"><code>numAffected</code> 和 <code>save()</code><a class="headerlink" href="#numaffected-save" title="Permanent link">&para;</a></h2>
<p><code>doc.save()</code> no longer passes <code>numAffected</code> as a 3rd param to its callback.</p>
<h2 id="remove-and-debouncing"><code>remove()</code> and debouncing<a class="headerlink" href="#remove-and-debouncing" title="Permanent link">&para;</a></h2>
<p><code>doc.remove()</code> no longer debounces</p>
<h2 id="getpromiseconstructor"><code>getPromiseConstructor()</code><a class="headerlink" href="#getpromiseconstructor" title="Permanent link">&para;</a></h2>
<p><code>getPromiseConstructor()</code> is gone, just use <code>mongoose.Promise</code>.</p>
<h2 id="passing-parameters-from-pre-hooks">Passing Parameters from Pre Hooks<a class="headerlink" href="#passing-parameters-from-pre-hooks" title="Permanent link">&para;</a></h2>
<p>You cannot pass parameters to the next pre middleware in the chain using <code>next()</code> in mongoose 5.x. In mongoose 4, <code>next('Test')</code> in pre middleware would call the
next middleware with 'Test' as a parameter. Mongoose 5.x has removed support for this.</p>
<h2 id="required">数组的<code>required</code>验证器<a class="headerlink" href="#required" title="Permanent link">&para;</a></h2>
<p>In mongoose 5 the <code>required</code> validator only verifies if the value is an array. That is, it will <strong>not</strong> fail for <em>empty</em> arrays as it would in mongoose 4.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../api/Error/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 错误" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              错误
            </div>
          </div>
        </a>
      
      
        
        <a href="../VersionCompatibility/" class="md-footer__link md-footer__link--next" aria-label="下一页: 版本兼容性" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              版本兼容性
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            版权 &copy; 2022 -  wdk-docs.github.io
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="http://wdk-docs.github.io" target="_blank" rel="noopener" title="wdk-docs.github.io" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/wdk-docs" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/wdk-docs" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://linkedin.com/in/wdk-docs" target="_blank" rel="noopener" title="linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.e99e714c.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.bc35569b.min.js"></script>
      
    
  </body>
</html>